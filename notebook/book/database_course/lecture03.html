<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Lecture 3 - Chux&#x27;s Notebook</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../katex.min.css">

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../intro.html">Introduction</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">1.</strong> Recommender Systems</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../gradient_boosting.html"><strong aria-hidden="true">1.1.</strong> Gradient Boosting</a></li><li class="chapter-item expanded "><a href="../tfidf.html"><strong aria-hidden="true">1.2.</strong> TF-IDF</a></li><li class="chapter-item expanded "><a href="../cross_encoders.html"><strong aria-hidden="true">1.3.</strong> Cross Encoders</a></li><li class="chapter-item expanded "><a href="../sentence_transformers.html"><strong aria-hidden="true">1.4.</strong> SentenceTransformers</a></li><li class="chapter-item expanded "><a href="../collab_filtering.html"><strong aria-hidden="true">1.5.</strong> Collaborative Filtering</a></li></ol></li><li class="chapter-item expanded "><a href="../ab_test/init.html"><strong aria-hidden="true">2.</strong> AB Testing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../ab_test/examples.html"><strong aria-hidden="true">2.1.</strong> Examples</a></li><li class="chapter-item expanded "><a href="../ab_test/power_analysis.html"><strong aria-hidden="true">2.2.</strong> Power Analysis</a></li></ol></li><li class="chapter-item expanded "><a href="../llm/llm.html"><strong aria-hidden="true">3.</strong> LLMs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../llm/fine_tuning.html"><strong aria-hidden="true">3.1.</strong> Fine-tuning</a></li><li class="chapter-item expanded "><a href="../llm/useful_models.html"><strong aria-hidden="true">3.2.</strong> Useful Models</a></li><li class="chapter-item expanded "><a href="../llm/encoder_vs_decoder.html"><strong aria-hidden="true">3.3.</strong> Encoder vs Decoder</a></li></ol></li><li class="chapter-item expanded "><a href="../misc.html"><strong aria-hidden="true">4.</strong> Miscellaneous</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../misc/bradley-terry.html"><strong aria-hidden="true">4.1.</strong> Bradley-Terry Model</a></li><li class="chapter-item expanded "><a href="../misc/wsl-setup.html"><strong aria-hidden="true">4.2.</strong> Setting up WSL</a></li><li class="chapter-item expanded "><a href="../misc/to-read.html"><strong aria-hidden="true">4.3.</strong> To Read</a></li><li class="chapter-item expanded "><a href="../misc/packages.html"><strong aria-hidden="true">4.4.</strong> Packages</a></li><li class="chapter-item expanded "><a href="../misc/skills.html"><strong aria-hidden="true">4.5.</strong> Skills</a></li></ol></li><li class="chapter-item expanded "><a href="../identities.html"><strong aria-hidden="true">5.</strong> Identities</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../identities/sigmoid.html"><strong aria-hidden="true">5.1.</strong> Sigmoid</a></li><li class="chapter-item expanded "><a href="../identities/statistics.html"><strong aria-hidden="true">5.2.</strong> Statistics</a></li></ol></li><li class="chapter-item expanded "><a href="../papers.html"><strong aria-hidden="true">6.</strong> Papers</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../papers/weinberger_2009.html"><strong aria-hidden="true">6.1.</strong> Weinberger 2009 - Hashing for Multitask Learning</a></li><li class="chapter-item expanded "><a href="../papers/burges_2010.html"><strong aria-hidden="true">6.2.</strong> Burges 2010 - RankNET to LambdaMART</a></li><li class="chapter-item expanded "><a href="../papers/schroff_2015.html"><strong aria-hidden="true">6.3.</strong> Schroff 2015 - FaceNET</a></li><li class="chapter-item expanded "><a href="../papers/schnabel_2016.html"><strong aria-hidden="true">6.4.</strong> Schnabel 2016 - Recs as Treatments</a></li><li class="chapter-item expanded "><a href="../papers/guo_2017.html"><strong aria-hidden="true">6.5.</strong> Guo 2017 - DeepFM</a></li><li class="chapter-item expanded "><a href="../papers/hamilton_2017.html"><strong aria-hidden="true">6.6.</strong> Hamilton 2017 - GraphSAGE</a></li><li class="chapter-item expanded "><a href="../papers/ma_2018.html"><strong aria-hidden="true">6.7.</strong> Ma 2018 - Entire Space Multi-Task Model</a></li><li class="chapter-item expanded "><a href="../papers/reimers_2019.html"><strong aria-hidden="true">6.8.</strong> Reimers 2019 - Sentence-BERT</a></li><li class="chapter-item expanded "><a href="../papers/he_2020.html"><strong aria-hidden="true">6.9.</strong> He 2020 - LightGCN</a></li><li class="chapter-item expanded "><a href="../papers/lewis_2020.html"><strong aria-hidden="true">6.10.</strong> Lewis 2020 - Retrieval Augmented Generation</a></li><li class="chapter-item expanded "><a href="../papers/gao_2021.html"><strong aria-hidden="true">6.11.</strong> Gao 2021 - SimCSE</a></li><li class="chapter-item expanded "><a href="../papers/weng_2021.html"><strong aria-hidden="true">6.12.</strong> Weng 2021 - Contrastive Representation Learning</a></li><li class="chapter-item expanded "><a href="../papers/dao_2022.html"><strong aria-hidden="true">6.13.</strong> Dao 2022 - Flash Attention</a></li><li class="chapter-item expanded "><a href="../papers/tunstall_2022.html"><strong aria-hidden="true">6.14.</strong> Tunstall 2022 - SetFit</a></li><li class="chapter-item expanded "><a href="../papers/rafailov_2023.html"><strong aria-hidden="true">6.15.</strong> Rafailov 2023 - Direct Preference Optimization</a></li><li class="chapter-item expanded "><a href="../papers/blecher_2023.html"><strong aria-hidden="true">6.16.</strong> Blecher 2023 - Nougat</a></li><li class="chapter-item expanded "><a href="../papers/borisyuk_2024.html"><strong aria-hidden="true">6.17.</strong> Borisyuk 2024 - GNN at LinkedIn</a></li><li class="chapter-item expanded "><a href="../papers/liu_2023.html"><strong aria-hidden="true">6.18.</strong> Liu 2023 - Meaning Representations from Trajectories</a></li></ol></li><li class="chapter-item expanded "><a href="../nlp_course/intro.html"><strong aria-hidden="true">7.</strong> NLP Course</a></li><li class="chapter-item expanded "><a href="../database_course/intro.html"><strong aria-hidden="true">8.</strong> Database Course</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../database_course/lecture01.html"><strong aria-hidden="true">8.1.</strong> Lecture 1</a></li><li class="chapter-item expanded "><a href="../database_course/lecture02.html"><strong aria-hidden="true">8.2.</strong> Lecture 2</a></li><li class="chapter-item expanded "><a href="../database_course/lecture03.html" class="active"><strong aria-hidden="true">8.3.</strong> Lecture 3</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Chux&#x27;s Notebook</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="lecture-3-database-storage-1"><a class="header" href="#lecture-3-database-storage-1">Lecture 3: Database Storage 1</a></h1>
<p>Class will shift gears towards how to implement a DBMS. Focus is on a single node machine first, then move to concurrency. Today's focus is on the <Disk Manager>.</p>
<p>Focus on <disk-based architecture>, i.e. the DBMS assumes that the primary storage location of the database is on non-volatile disk. The DBMS's components manage the movement of data between volatile (e.g. RAM) and non-volatile storage.</p>
<p>Storage hierarchy. Higher rank is faster, smaller, expensive.</p>
<ol>
<li>CPU Registers</li>
<li>CPU Caches</li>
<li>DRAM (i.e. memory)</li>
<li>SSD</li>
<li>HDD</li>
<li>Network Storage</li>
</ol>
<p>Items 1-3 are volatile, i.e. random access, byte-addressable (we can fetch specific bytes). Items 4-6 are non-volatile, i.e. sequential access, block-addressable. For non-volatile storage, we need to fetch data one block at a time, and accessing data in one contiguous block sequentially is much faster than trying to access blocks scattered around. CPU refers to items 1 and 2, Memory refers to item 3, Disk refers to items 4-6.</p>
<p>Some new storage category: Fast network storage is in between HDD and SSD. Persistent Memory is between SSD and DRAM.</p>
<p>DBMSs need to exploit the sequential access on non-volatile memory to maximize speed of retrieval. Hence how we store data contiguously matters in the design of the DBMS.</p>
<p>Access times:</p>
<pre><code>- 1 ns          L1 Cache Ref        1 sec
- 4 ns          L2 Cache Ref        4 sec
- 100 ns        DRAM                100 sec
- 16,000 ns     SSD                 4.4 hours
- 2,000,000 ns  HDD                 3.3 weeks
- 50,000,000 ns Network Storage     1.5 years
</code></pre>
<h2 id="system-design-goals"><a class="header" href="#system-design-goals">System Design Goals</a></h2>
<p>The overall goal is to make it appear like we have more memory than we do:</p>
<ol>
<li>We want to allow the DBMS to manage databases that exceed the amount of memory available.</li>
<li>Reading/ writing to disk is expensive, so it must be managed carefully to avoid large stalls.</li>
<li>Random access on disk is much slower, so DBMS wants to maximize sequential access.</li>
</ol>
<h2 id="disk-oriented-dbms"><a class="header" href="#disk-oriented-dbms">Disk oriented DBMS</a></h2>
<p>On disk, we have database files stored in pages. Each page is a block of data. When an execution engine makes a query, it loads a page into buffer pool in memory. The buffer pool returns a 64-bit pointer to the memory location where the page is located. The execution engine interprets the layout of the page, updates it. The new page is then written back into the database file on disk.</p>
<h2 id="why-not-use-the-os"><a class="header" href="#why-not-use-the-os">Why not use the OS?</a></h2>
<p>The DBMS could potentially use memory mapping <code>mmap</code> to store the contents of a file (or page) in the address space of a program. The benefit is that we can tap on the OS to decide which pages to load into physical memory and when to swap pages out. The downside is that the lack of control over memory management can lead to stalling and bad performance.</p>
<p>How the OS works:</p>
<ol>
<li>Suppose we have Page 1, ..., Page 4 on disk. There's only enough space in physical memory to load 2 pages.</li>
<li>The OS represents this to the program as virtual memory, where Page 1, ..., Page 4 are available</li>
<li>When the program touches Page 2, the OS will load Page 2 into physical memory and return a pointer to the program</li>
<li>Suppose the program now touches Page 3 and Page 4</li>
<li>The OS needs to decide which page to evict from physical memory</li>
</ol>
<p>So the problems with using <code>mmap</code> to handle I/O for the DBMS:</p>
<ol>
<li>Transaction safety. The OS can flush dirty pages to disk at any time, even mid-write. We can get corrupted data on disk.</li>
<li>I/O stalls. The DBMS does not know which pages are in memory, so the OS could stall due to page faults (fetching a page not in memory).</li>
<li>Error handling. Difficult to validate pages. Any access can cause a <code>SIGBUS</code> that the DBMS needs to handle.</li>
<li>Performance issues. The OS has its own scheduling and data structures, and can contend with the DBMS's priorities.</li>
</ol>
<p>There are some companies that use <code>mmap</code>:</p>
<ul>
<li>RavenDB</li>
<li>ElasticSearch</li>
<li>QuestDB</li>
<li>MongoDB (moved away from <code>mmap</code>)</li>
</ul>
<p>So DBMS almost always wants to control things itself:</p>
<ul>
<li>Flushing dity pages to disk in the correct order</li>
<li>Specialized pre-fetching</li>
<li>Buffer replacement policy</li>
<li>Thread / process scheduling</li>
</ul>
<p>Paper on this: <a href="https://db.cs.cmu.edu/papers/2022/cidr2022-p13-crotty.pdf">Are you sure you want to Use MMAP in your DBMS?</a></p>
<p>For database storage, we need to deal with two problems:</p>
<ol>
<li>How the DBMS represents the database in files on disk</li>
<li>How the DBMS manages its memory and moves data back and forth from disk</li>
</ol>
<h2 id="file-storage"><a class="header" href="#file-storage">File Storage</a></h2>
<p>The DBMS stores a database as one or more files on disk typically in a proprietary format. The OS doesn't know anything about the contents of these files. There are portable file formats (e.g. parquet etc.). Early systems in 1980s further used custom <em>filesystems</em> on raw block storage. Most newer DBMSs do not do this.</p>
<p>The <storage manager> is responsible for maintaining a database's files. It organizes the files as a collection of pages, and tracks the data read / written to pages, and tracks the available space in each page. A DBMS does not typically maintain multiple copies of a page on disk. This happens above or below the storage manager.</p>
<p>A <page> is a fixed-size block of data. It can contain tuples, meta-data, indexes, logs etc. Most systems do not mix page types. Some systems require a page to be self-contained, i.e. all the information needed to understand the data in the page is contained within the page itself (e.g. Oracle). Each page is given a unique identifier. The DBMS uses an indirection layer to map page IDs to physical locations (e.g. in memory or in S3 or whatever).</p>
<p>There are 3 different notions of what a page is:</p>
<ol>
<li>Hardware page (typically <code>4KB</code>). A hardware page is the largest block of data that the storage device can guarantee failsafe writes (i.e. if it says it wrote <code>4KB</code>, it actually happened).</li>
<li>OS Page (usually <code>4KB</code>, but can be much larger)</li>
<li>Database Page (<code>512B</code> to <code>32KB</code>)</li>
</ol>
<p>Why might a larger page size be a good idea? Sequential data access. If we request a page of <code>16KB</code>, it is one call to the OS and data is stored sequentially. If we request 4 pages of <code>4KB</code> each, it is potentially random access. But the downside is that writing to a larger page is slower than writing to a small one.</p>
<h2 id="page-storage-architecture"><a class="header" href="#page-storage-architecture">Page Storage Architecture</a></h2>
<p>How do DBMSs map page IDs to physical location? Different approaches:</p>
<ul>
<li>Heap file organization &lt;- most common</li>
<li>Tree file organization</li>
<li>Sequential / Sorted File Organization (ISAM)</li>
<li>Hashing file organization</li>
</ul>
<p>A <span style="color:orange">heap file</span> is an unordered collection of pages with tuples that are stored in random order.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../database_course/lecture02.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../database_course/lecture02.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
