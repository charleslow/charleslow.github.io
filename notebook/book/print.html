<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Charles&#x27; Notebook</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="intro.html">Introduction</a></li><li class="chapter-item expanded "><a href="misc.html"><strong aria-hidden="true">1.</strong> Miscellaneous</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Recommender Systems</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">2.1.</strong> Two Tower</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.2.</strong> Diversity</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.3.</strong> Exposure Bias</div></li></ol></li><li class="chapter-item expanded "><a href="papers.html"><strong aria-hidden="true">3.</strong> Papers</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="schnabel_2016.html"><strong aria-hidden="true">3.1.</strong> Schnabel 2016 - Recs as Treatments</a></li></ol></li><li class="chapter-item expanded "><a href="sketch.html"><strong aria-hidden="true">4.</strong> Sketchbook</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Charles&#x27; Notebook</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p>This is a collection of my notes which I refer to on a regular basis. Hope it is also helpful for others stumbling by.</p>
<p>Built with <a href="https://rust-lang.github.io/mdBook/">mdBook</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="miscellaneous-notes"><a class="header" href="#miscellaneous-notes">Miscellaneous Notes</a></h1>
<p>A collection of miscellaneous, useful notes.</p>
<h2 id="numpy-indexing"><a class="header" href="#numpy-indexing">Numpy Indexing</a></h2>
<p>Suppose we have a 2D array <code>X</code> and would like to take a slice of certain rows and columns. We might try, for e.g., to take the first two rows of X and the 3rd/4th column of X, i.e. we expect to get a 2 by 2 matrix.</p>
<pre><code class="language-python">import numpy as np
X = np.random.randn(5, 5)
X[[0, 1], [2, 3]]
</code></pre>
<p>Unfortunately, this will return an array of items <code>array(X[0, 2], X[1, 3])</code>, which is not what we want. Instead, a slightly inefficient but clear way is to slice each axis separately. It is not optimal because the first slice creates a temporary array view before the second slice is applied.</p>
<pre><code class="language-python">X[[0, 1], :][:, [2, 3]]
</code></pre>
<p>Finally, the recommended way seems to be to use <code>np.ix_</code>. Doing <code>np.ix_([0, 1], [2, 3])</code> creates a tuple of two elements.</p>
<pre><code class="language-python">idx = np.ix_([0, 1], [2, 3])
idx
&gt;&gt; (array([[0],
           [1]]),
&gt;&gt;  array([[2, 3]]))
</code></pre>
<p>Indexing the original array with this output <code>X[idx]</code> will then give us what we want.</p>
<h2 id="asyncio"><a class="header" href="#asyncio">asyncio</a></h2>
<p><a href="https://realpython.com/async-io-python/">reference</a></p>
<p>asyncio is a single-threaded framework that does not use multi-threading or multi-processing to speed up tasks. Instead, a coordinator (or event loop) passes control from a time-consuming blocking function (e.g. time.sleep or an I/O operation) to other functions to run. This passing of control occurs with the <code>await</code> keyword. When the blocking function is completed, it notifies the coordinator and control returns to where the blocking function left off.</p>
<p><code>asyncio</code> does not speed up CPU-bound tasks, due to its single-threaded design. It only works when the function being awaited is an I/O operation that is supported by asyncio. This includes <a href="https://realpython.com/async-io-python/#libraries-that-work-with-asyncawait">stuff</a> like:</p>
<ul>
<li>HTTP (supported through <code>aiohttp</code>)</li>
<li>DB calls (e.g. <code>aioredis</code>)</li>
</ul>
<p><code>asyncio</code> is preferred for such tasks (e.g. making multiple I/O calls and doing something when they all return) over multi-processing because of its single-thread design, making it easier to debug.</p>
<div style="break-before: page; page-break-before: always;"></div><p>Summaries of individual papers that I have taken a deeper look into.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="recommendations-as-treatments"><a class="header" href="#recommendations-as-treatments">Recommendations as Treatments</a></h1>
<p><a href="https://arxiv.org/pdf/1602.05352.pdf">Paper Link</a>.</p>
<p>Training and evaluation data for recommender systems is subject to selection bias, because the probability of observing a data point depends on (i) users interacting with items which they like and (ii) the recommender system pushing items which they think the user likes. This leads to data Missing Not at Random (MNAR) and leads to biased model training and evaluation.</p>
<p>Consider users interacting with movies. Denote users \( u \in \{ 1, ..., U \} \) and movies \( i \in \{ 1, ..., I \} \). Let \( Y \in \mathbb{R}^{U \times I} \) denote the true rating / interaction matrix between user and item, and \( \hat{Y} \) the predicted matrix. Let \( O \in \{ 0, 1 \}^{U \times I} \) be the observability matrix of whether an interaction was observed, and \( P \in \mathbb{R}^{U \times I} \) be the probability of observation, i.e. \( P_{u,i} = P(O_{u,i} = 1) \). Ideally, we want the propensity matrix <code>P</code> to be uniform across all entries, which gives us the Missing Completely at Random (MCAR) condition.</p>
<h2 id="evaluating-only-on-observed-entries-is-biased"><a class="header" href="#evaluating-only-on-observed-entries-is-biased">Evaluating only on observed entries is biased</a></h2>
<p>Given a model \( \hat{Y} \), we often want to compute evaluation metrics \( \delta_{u,i}(\hat{Y}, Y) \) on how well \( \hat{Y} \) approximates \( Y \). For example:</p>
<p>\[
\delta_{u,i}(\hat{Y}, Y) = (Y_{u,i} - \hat{Y}_{u,i})^2 \ \ \text{MSE}
\]</p>
<p>\[
\delta_{u,i}(\hat{Y}, Y) = \frac{Y_{u,i}}{logrank( \hat{Y}_{u,i} )} \ \ \text{DCG}
\]</p>
<p>The Risk function may then be denoted:</p>
<p>\[
R(\hat{Y}) = \frac{\sum_u \sum_i \delta_{u,i}(\hat{Y}, Y)}{U \times I}
\]</p>
<p>However, \( R(\hat{Y}) \) cannot be computed because most entries in \( Y \) are missing. Typically, we estimate \( \hat{R} \) using only observed entries. This estimator is naive because it simply assumes the propensity matrix \( P \) is uniform. This assumption is often false in recommender systems because a small set of popular items tend to get impressed a lot. Hence this estimator will favour models that lean towards the popular items compared to models that recommend rarer / new items.</p>
<p>\[
\hat{R}_{\text{naive}}(\hat{Y}) = 
\frac{1}{| { (u, i): O_{u,i} = 1  } |} 
\cdot 
\sum_{u,i: O_{u,i}=1} \delta_{u,i}(\hat{Y}, Y)
\]</p>
<h2 id="unbiased-estimators"><a class="header" href="#unbiased-estimators">Unbiased estimators</a></h2>
<p>The main idea in this paper is to view this problem as analogous to estimating treatment effects in causal inference. Think of recommending an item as an intervention analogous to treating a patient with a specific drug. The goal is to estimate the outcome of a new recommendation (clicked or not) or new treatment (recovered or not), while most outcomes between <code>u,i</code> pairs are not known.</p>
<p>The key to resolving this bias is to understand the assignment mechanism that generated \( O \), namely the propensity matrix \( P \). We can then correct for the propensity. We need to assume that \( P_{u,i} &gt; 0 \forall u, i \), i.e. full support, because otherwise the IPS estimator below is undefined.</p>
<h3 id="ips-estimator"><a class="header" href="#ips-estimator">IPS Estimator</a></h3>
<p>The main estimator is the Inverse Propensity Score (IPS) estimator. Assuming that the assignment mechanism \( P \) is known:</p>
<p>\[
\hat{R}_{\text{ips}}(\hat{Y} | P) = 
\frac{1}{| { (u, i): O_{u,i} = 1  } |} 
\cdot 
\sum_{u,i: O_{u,i}=1} \frac{\delta_{u,i}(\hat{Y}, Y)}{P_{u,i}}
\]</p>
<p>We have simply normalized each score by its inverse propensity, so that popular items with a high chance of being shown get their score reduced proportionally (and likewise in the opposite direction for rare items).</p>
<h2 id="comments"><a class="header" href="#comments">Comments</a></h2>
<ul>
<li>This paper only addresses exposure bias, but not position bias. In other words, it assumes that all impressions are equal, which is valid when a user is shown an ad, but not when a user is shown a list of search results. In the latter case, items in lower positions have a lower probability of being considered by the user, even though both are considered to be observed. </li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>

    </div>
    </body>
</html>
